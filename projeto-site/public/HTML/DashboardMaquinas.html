<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fluid</title>
    <link rel="stylesheet" href="../CSS/Navbar.css">
    <link rel="stylesheet" href="../CSS/DashboardMaquinas.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" crossorigin="anonymous">
    <script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital@1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
    <script type="text/javascript" src="../funcoes.js"></script>
</head>

<body onload="verificar_autenticacao()">

    <div class="container">
        <div class="navbar">
            <div class="logo">
                <img src="../ASSETS/Fluid-Icon.png">
                <h1>FLUID</h1>
            </div>

            <div class="usuario-info">
                <img src="../ASSETS/user.png" alt="">
                <h3><b id="b_usuario">Usuário</b></h3>

            </div>

            <ul>
                <li><a href="DashboardHome.html"><button><i class="fas fa-home"></i>Home</button></a></li>
                <li id="cadastrar"><a href="DashboardCadastro.html"><button><i class="fas fa-user-plus"></i>Cadastrar</button></a></li>
                <li><a href="DashboardMaquinas.html"><button><i class="fas fa-chart-bar"></i>Dashboard</button></a></li>                
                <li><a href="#"><button><i class="far fa-user"></i>Perfil</button></a></li>
                <li><button onclick="logoff()"><i class="far fa-times-circle"></i>Sair</button></li>
            </ul>
        </div>


        <div class="div-aux"></div>

        <div class="main">

            <h1 class="titulo">Dashboard</h1>

            <div class="container-info-maquinas">
                <h1>Selecione uma máquina:</h1>
                <select name="" id="selectMaquina" onchange="mapearDiscos()">
                </select>

                <div class="card-hostname">
                    <div class="container-label">
                        <label for=""><b>Hostname: </b></label>
                        <label for="" id="hostnameLabel">xxxxxx</label>
                    </div>
                </div>

                <div class="card-historico">
                    <h1>Histórico</h1>
                    <div class="container-info-historico">
                        <div class="container-label">
                            <label for=""><b>Última edição: </b></label>
                            <label for="" id="lastEdit">20/05/2021</label>
                        </div>
                        <div class="container-label">
                            <label for=""><b>Último usuário ativo: </b></label>
                            <label for="" id="lastUser">usuarioX</label>
                        </div>
                    </div>
                </div>

                <div class="container-mensagem">
                    <h3>Os dados a seguir são com base nas coletas dos ultimos sete dias</h3>
                </div>

                <div class="container-hardware">
                    <div class="container-card-hardwarer">
                        <div class="card-hardware" id="card-cpu" onclick="trocar_grafico(this.id)">
                            <h1>CPU</h1>
                            <label for="" id="cpuMedia">70%</label>
                            <h3>Média de uso</h3>
                        </div>
                        <div class="card-hardware" id="card-gpu" onclick="trocar_grafico(this.id)">
                            <h1>GPU</h1>
                            <label for="">90ºC</label>
                            <h3>Temperatura média</h3>
                        </div>
                        <div class="card-hardware" id="card-ram" onclick="trocar_grafico(this.id)">
                            <h1>RAM</h1>
                            <label for="">70%</label>
                            <h3>Média de uso</h3>
                        </div>
                        <div class="card-hardware" id="card-disco" onclick="trocar_grafico(this.id)">
                            <select name="" id="selectDiscos">
                            </select>
                            <label for="">70%</label>
                            <h3>Espaço em uso</h3>
                        </div>
                    </div>

                    <div class="container-canva-hardware" id="canva-cpu">
                        <canvas id="graficoCPU" height="110vh"></canvas>
                    </div>

                    <div class="container-canva-hardware" id="canva-gpu">
                        <canvas id='graficoGPU' height="110vh"></canvas>
                    </div>

                    <div class="container-canva-hardware" id="canva-ram">
                        <canvas id="graficoRAM" height="110vh"></canvas>
                    </div>

                    <div class="container-canva-hardware" id="canva-disco">
                        <canvas height="110vh"></canvas>
                    </div>
                </div>
            </div>


        </div>






    </div>

</body>

</html>

<script>
    window.onload = verificar_autenticacao();
    function trocar_grafico(clicked_id) {
        // document.getElementById(clicked_id).style.display = "block";

        document.getElementById("canva-cpu").style.display = "none";
        document.getElementById("canva-gpu").style.display = "none";
        document.getElementById("canva-ram").style.display = "none";
        document.getElementById("canva-disco").style.display = "none";


        switch (clicked_id) {
            case "card-cpu":
                document.getElementById("canva-cpu").style.display = "block";
                break

            case "card-gpu":
                document.getElementById("canva-gpu").style.display = "block";
                break

            case "card-ram":
                document.getElementById("canva-ram").style.display = "block";
                break

            case "card-disco":
                document.getElementById("canva-disco").style.display = "block";
                break

        }
    }

    var tipoUsuario = sessionStorage.tipo_usuario_meuapp;
    
    if(tipoUsuario == 2) {
        cadastrar.style.display = "none";
    }

    window.onload = mapearComputadores();

    function mapearComputadores() {
        //aguardar();
        fetch(`/usuarios/listarComputadores`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        for (var aux = 0; aux < resposta.length; aux++){
                            var hostname = resposta[aux].hostname;
                            var computador = resposta[aux].id;
                            selectMaquina.innerHTML += `<option value="${computador}">${hostname}</option>`;
                        }
                        hostnameLabel.innerHTML = resposta[0].hostname;
                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do setor p/ gráfico: ${error.message}`);
            });
    }

    function retornarAcesso() {
        fetch(`/usuarios/acesso/${selectMaquina.value}`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        lastUser.innerHTML = resposta[0].nomeUsuario;

                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do setor p/ gráfico: ${error.message}`);
            });
    }

    function mapearDiscos() {
        selectDiscos.innerHTML = "";
        fetch(`/usuarios/listarDiscos/${selectMaquina.value}`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        for(var aux = 0; aux < 3; aux++) {
                            if (aux == 0) {
                                var hardware = resposta[aux].hardware;
                                selectDiscos.innerHTML += `<option value="${hardware}">Disco ${aux + 1}</option>`;
                            }
                            else if(resposta[aux].hardware != resposta[aux-1].hardware && resposta[aux].hardware != resposta[aux+1].hardware) {
                                var hardware = resposta[aux].hardware;
                                selectDiscos.innerHTML += `<option value="${hardware}">Disco ${aux + 1}</option>`;
                            }
                        }
                        retornarAcesso();
                        mediaCPU();
                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do setor p/ gráfico: ${error.message}`);
            });
    }

    function mediaCPU() {
        fetch(`/usuarios/mediaCPU/${selectMaquina.value}`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        cpuMedia.innerHTML = `${resposta[0].media}%`;

                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do setor p/ gráfico: ${error.message}`);
            });
    }

    // Temp GPU
    var config_tempGPU = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura',
                backgroundColor: '#a738e8',
                borderColor: '#a738e8',
                data: [],
                fill: true,
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Gráfico de histórico de temperatura da GPU'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Horário da Leitura'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'ºC'
                    }
                }]
            }
        }
    };
    //uso RAM
    var config_usoRAM = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Uso de memória RAM',
                backgroundColor: '#a738e8',
                borderColor: '#a738e8',
                data: [],
                fill: true,
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Gráfico de histórico de % de uso de RAM'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Horário da Leitura'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: '% de uso'
                    }
                }]
            }
        }
    };
    //uso CPU
    var config_usoCPU = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '% de uso da CPU',
                backgroundColor: '#a738e8',
                borderColor: '#a738e8',
                data: [],
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            title: {
                display: true,
                text: 'Gráfico de histórico de % de uso da CPU'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Horário da Leitura'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: '% de uso'
                    }
                }]
            }
        }
    };

    //Temp
    function sortearTemperatura() {
        var limiteMin = 30;
        var limiteMax = 80;
        // var minimoAbsoluto = Math.abs(limiteMin);
        return (Math.random() * (limiteMax - limiteMin) + limiteMin).toFixed(1);
    }


    function recuperarDadosIniciais_usoRAM() {

        // esse "registros" será recuperado do backend futuramente
        var registros = [
            {
                momento: '00:03:42',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:03:52',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:02',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:12',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:22',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:32',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:42',
                leitura: sortearTemperatura()
            }
        ];

        var contador = 0;

        // registros.length é a quantidade de itens em "registros"
        while (contador < registros.length) {

            config_usoRAM.data.labels.push(registros[contador].momento);  // incluir um novo momento
            config_usoRAM.data.datasets[0].data.push(registros[contador].leitura);  // incluir uma nova leitura

            contador++;
        }

    }

    //uso RAM
    function sortearUsoRAM() {
        min = 10;
        max = 99;

        let random = Math.floor(Math.random() * (max - min + 1) + min);

        return random
    }

     //uso CPU
     function sortearUsoCPU() {
        min = 10;
        max = 99;

        let random = Math.floor(Math.random() * (max - min + 1) + min);

        return random
    }

    function recuperarDadosIniciais_tempGPU() {

        // esse "registros" será recuperado do backend futuramente
        var registros = [
            {
                momento: '00:03:42',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:03:52',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:02',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:12',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:22',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:32',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:42',
                leitura: sortearTemperatura()
            }
        ];

        var contador = 0;

        // registros.length é a quantidade de itens em "registros"
        while (contador < registros.length) {

            config_tempGPU.data.labels.push(registros[contador].momento);  // incluir um novo momento
            config_tempGPU.data.datasets[0].data.push(registros[contador].leitura);  // incluir uma nova leitura

            contador++;
        }

    }

    function recuperarDadosIniciais_usoCPU() {

    // esse "registros" será recuperado do backend futuramente
    var registros = [
        {
            momento: '00:03:42',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:03:52',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:04:02',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:04:12',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:04:22',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:04:32',
            leitura: sortearUsoCPU()
        },
        {
            momento: '00:04:42',
            leitura: sortearUsoCPU()
        }
    ];

    var contador = 0;

    // registros.length é a quantidade de itens em "registros"
    while (contador < registros.length) {

        config_usoCPU.data.labels.push(registros[contador].momento);  // incluir um novo momento
        config_usoCPU.data.datasets[0].data.push(registros[contador].leitura);  // incluir uma nova leitura

        contador++;
    }

    }

    //atualização de dados:
    //USO RAM

    var divisor1 = 0;
    var total1 = 0;
    var armazenador1 = [];

    function receberNovasLeituras_usoRAM() {
        setTimeout(() => {

            // esses "agora" etc até "momentos" serão desnecessários quando usarmos o backend futuramente
            var agora = new Date();
            var hora = agora.getHours();
            var minuto = agora.getMinutes();
            var segundo = agora.getSeconds();
            var momento = `${hora > 9 ? '' : '0'}${hora}:${minuto > 9 ? '' : '0'}${minuto}:${segundo > 9 ? '' : '0'}${segundo}`;

            // esse "novoRegistro" será recuperado do backend futuramente
            var novoRegistro = {
                momento: momento,
                leitura: sortearUsoRAM()
            };

            // tirando e colocando valores no gráfico
            config_usoRAM.data.labels.shift(); // apagar o primeiro
            config_usoRAM.data.labels.push(novoRegistro.momento); // incluir um novo momento
            config_usoRAM.data.datasets[0].data.shift();  // apagar o primeiro
            config_usoRAM.data.datasets[0].data.push(novoRegistro.leitura); // incluir uma nova leitura

            // Atualiza o gráfico
            window.graficoLinhaUsoRAM.update();

            armazenador1.push(novoRegistro.leitura);
            total1 += parseInt(novoRegistro.leitura);
            divisor1++;

            // agendar a chamada da mesma função para daqui a 7 segundos
            receberNovasLeituras_usoRAM();

            // for(var i = 0; i < total[i]; i++) {
            //     total[i];
            // }
            // document.getElementById('media_usoRAM').innerHTML = (total1 / divisor1).toFixed(2);
            // document.getElementById('max_usoRAM').innerHTML = max(armazenador1);

        }, 1000); // 7000 ms -> 7 segundos

        function max(input) {
        if (toString.call(input) !== "[object Array]") {
            return false;
        }
        return Math.max.apply(null, input);
        }
    }

    // TEMP GPU
    var divisor2 = 0;
    var total2 = 0;
    var armazenador2 = [];

    function receberNovasLeituras_tempGPU() {
        setTimeout(() => {

            // esses "agora" etc até "momentos" serão desnecessários quando usarmos o backend futuramente
            var agora = new Date();
            var hora = agora.getHours();
            var minuto = agora.getMinutes();
            var segundo = agora.getSeconds();
            var momento = `${hora > 9 ? '' : '0'}${hora}:${minuto > 9 ? '' : '0'}${minuto}:${segundo > 9 ? '' : '0'}${segundo}`;

            // esse "novoRegistro" será recuperado do backend futuramente
            var novoRegistro = {
                momento: momento,
                leitura: sortearTemperatura()
            };

            // tirando e colocando valores no gráfico
            config_tempGPU.data.labels.shift(); // apagar o primeiro
            config_tempGPU.data.labels.push(novoRegistro.momento); // incluir um novo momento
            config_tempGPU.data.datasets[0].data.shift();  // apagar o primeiro
            config_tempGPU.data.datasets[0].data.push(novoRegistro.leitura); // incluir uma nova leitura

            // Atualiza o gráfico
            window.graficoLinhaTempGPU.update();

            armazenador2.push(novoRegistro.leitura);
            total2 += parseInt(novoRegistro.leitura);
            divisor2++;

            // agendar a chamada da mesma função para daqui a 7 segundos
            receberNovasLeituras_tempGPU();

            // document.getElementById('media_TempGPU').innerHTML = (total2 / divisor2).toFixed(2);
            // document.getElementById('max_TempGPU').innerHTML = max(armazenador2);

        }, 1000); // 7000 ms -> 7 segundos

        function max(input) {
        if (toString.call(input) !== "[object Array]") {
            return false;
        }
        return Math.max.apply(null, input);
        }
    }

    //USO RAM

    var divisor3 = 0;
    var total3 = 0;
    var armazenador3 = [];

    function receberNovasLeituras_usoCPU() {
        setTimeout(() => {

            // esses "agora" etc até "momentos" serão desnecessários quando usarmos o backend futuramente
            var agora = new Date();
            var hora = agora.getHours();
            var minuto = agora.getMinutes();
            var segundo = agora.getSeconds();
            var momento = `${hora > 9 ? '' : '0'}${hora}:${minuto > 9 ? '' : '0'}${minuto}:${segundo > 9 ? '' : '0'}${segundo}`;

            // esse "novoRegistro" será recuperado do backend futuramente
            var novoRegistro = {
                momento: momento,
                leitura: sortearUsoCPU()
            };

            // tirando e colocando valores no gráfico
            config_usoCPU.data.labels.shift(); // apagar o primeiro
            config_usoCPU.data.labels.push(novoRegistro.momento); // incluir um novo momento
            config_usoCPU.data.datasets[0].data.shift();  // apagar o primeiro
            config_usoCPU.data.datasets[0].data.push(novoRegistro.leitura); // incluir uma nova leitura

            // Atualiza o gráfico
            window.graficoLinhaUsoCPU.update();

            armazenador3.push(novoRegistro.leitura);
            total3 += parseInt(novoRegistro.leitura);
            divisor3++;

            // agendar a chamada da mesma função para daqui a 7 segundos
            receberNovasLeituras_usoCPU();

            // for(var i = 0; i < total[i]; i++) {
            //     total[i];
            // }
            // document.getElementById('media_usoCPU').innerHTML = (total3 / divisor3).toFixed(2);
            // document.getElementById('max_usoCPU').innerHTML = max(armazenador3);

        }, 1000); // 7000 ms -> 7 segundos

        function max(input) {
        if (toString.call(input) !== "[object Array]") {
            return false;
        }
        return Math.max.apply(null, input);
        }
    }

    // plotar graficos

    function plotarGrafico() {
        // chamar os 7 últimos registros de leitura

        recuperarDadosIniciais_usoRAM();
        recuperarDadosIniciais_tempGPU();
        recuperarDadosIniciais_usoCPU();

        //Atualizar leituras

        receberNovasLeituras_usoRAM();
        receberNovasLeituras_tempGPU();
        receberNovasLeituras_usoCPU();


        // criação do gráfico na página

        var atx = document.getElementById('graficoGPU').getContext('2d');
        window.graficoLinhaTempGPU = new Chart(atx, config_tempGPU);

        var btx = document.getElementById('graficoRAM').getContext('2d');
        window.graficoLinhaUsoRAM = new Chart(btx, config_usoRAM);

        var ctx = document.getElementById('graficoCPU').getContext('2d');
        window.graficoLinhaUsoCPU = new Chart(ctx, config_usoCPU);

    }

    window.onload = plotarGrafico;
</script>